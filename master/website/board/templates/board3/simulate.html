{% extends "base.html" %}
{% load static %}

{% block scripts %}
{{ block.super }}
{% endblock %}

{% block body %}

{% include "navbar.html" %}
{% include "sidebar.html" %}


<section id="main-content">
    <section class="wrapper">
        <div class="row">
            <div class="col-lg-12">
                <h3 class="page-header"><i class="fa fa-desktop"></i>Simulate</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-11 col-md-12">

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h2><i class="icon_piechart"></i><strong>예측데이터</strong></h2>
                        <div class="panel-actions">
                            <a href="#" class="btn-setting"><i class="fa fa-rotate-right"></i></a>
                            <a href="#" class="btn-minimize"><i class="fa fa-chevron-up"></i></a>
                            <a href="#" class="btn-close"><i class="fa fa-times"></i></a>
                        </div>
                    </div>
                    <section class="panel">
                        <div class="panel-body text-center" id="simul_canvas">
                            <canvas height="300" width="1500"></canvas>
                        </div>
                    </section>

                </div>
            </div>
            <div class="col-md-1">
                <i><strong>변동비%</strong></i><input type="number" id="variable" class="form-control">
                <br>
                <i><strong>고정비%</strong></i><input type="number" id="fixed" class="form-control">
                <br>
                <i><strong>재료비%</strong></i><input type="number" id="material" class="form-control">
                <br>
                <button class="btn btn-default btn-lg" onclick="insertData();">예측</button>
            </div>

        </div>
    </section>
    <!--main content end-->
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>
    //var simul_canvas = document.getElementById('simul_canvas').getContext('2d');
    var simul_data;
    var simul_opt;
    var simul_chart;

    var this_year = new Date().getFullYear();
    var this_month = new Date().getMonth() + 1;

    var csrftoken = getCookie('csrftoken');
    function getCookie(name) {
        var cookieValue = null;

        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');

            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);

                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            if (xhr.status == 200) {
                var data = xhr.responseText;

                var obj = JSON.parse(data);
                if (obj.flag == '0') {
                    //alert(obj.template_url);
                    location.href = obj.template_url;
                } else {
                    alert(obj.result_msg);
                }
            }
        }
    };

    function insertData() {
        var variable = document.getElementById('variable').value;
        var fixed = document.getElementById('fixed').value;
        var material = document.getElementById('material').value;
        var payload = {
            "prediction1_cost": 0,
            "prediction2_cost": 0,
            "prediction3_cost": 0,
            "periodym1_cd": (this_year * 100 + this_month) * 100 + 1,
            "periodym2_cd": (this_year + Math.floor((this_month + 1) / 13)) * 10000 + (this_month % 12 + 1) * 100 + 1,
            "periodym3_cd": (this_year + Math.floor((this_month + 2) / 13)) * 10000 + ((this_month + 1) % 12 + 1) * 100 + 1,
            "variableperc_cost": variable,
            "fixedperc_cost": fixed,
            "materialperc_cost": material,
            'prediction1_max': 0,
            'prediction2_max': 0,
            'prediction3_max': 0,
            'prediction1_min': 0,
            'prediction2_min': 0,
            'prediction3_min': 0
        };

        var strurl = "http://127.0.0.1:8080/rest_api/ca-prediction";
        xhr.open("POST", strurl, true);
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify(payload));
    }

    function initialize_chart_data() {
        simul_data = {};
        simul_opt = {};
    }

    function draw_chart() {
        simul_chart = new Chart(simul_canvas, {
            type: 'line',
            data: simul_data,
            options: simul_opt
        });
    }
</script>

{% endblock %}