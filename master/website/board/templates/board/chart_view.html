{% extends "base.html" %}
{% load static %}

{% block scripts %}
    {{ block.super }}
{% endblock %}

{% block body %}

    {% include "navbar.html" %}
    {% include "sidebar.html" %}

    <style>
        .chartWrapper {
            position: relative;
        }

        .chartWrapper > canvas {
            position: absolute;
            left: 0;
            top: 0;
            pointer-events: none;
        }

        .chartAreaWrapper {
            width: 600px;
            overflow-x: scroll;
        }
    </style>

    <section id="main-content">
        <section class="wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h3 class="page-header"><i class="fa fa-table"></i> 원가 차트</h3>
                </div>
            </div>

            <div id="container" class="chartWrapper" style="width:100%;">
                <div class="chartAreaWrapper">
                    <canvas id="pie-chart" height="400"></canvas>
                </div>

                <button id="version_id" onclick="draw_chart('version_id')">version_id</button>
                <button id="ic_idlc" onclick="draw_chart('ic_idlc')">ic_idlc</button>
                <button id="ic_dlfc" onclick="draw_chart('ic_dlfc')">ic_dlfc</button>
                <button id="ic_idohc" onclick="draw_chart('ic_idohc')">ic_idohc</button>
                <button id="ic_ohdfe" onclick="draw_chart('ic_ohdfe')">ic_ohdfe</button>
                <button id="proamt_unit" onclick="draw_chart('proamt_unit')">proamt_unit</button>
                <button id="proamt_acc" onclick="draw_chart('proamt_acc')">proamt_acc</button>
                <button id="proq" onclick="draw_chart('proq')">proq</button>
            </div>
        </section>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script>
        let myChartOne = document.getElementById('pie-chart').getContext('2d');
        let dataMap = new Map();

        let _labels=[];
        let _datas=[];
        let _colors=[];
        let max_val;
        let min_val;

        function getCookie(name) {
            var cookieValue = null;

            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');

                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?

                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');
        var xhr;

        window.onload = function() {
            draw_chart('ic_idlc');
        }

        function draw_chart(label) {
            // var txt = document.getElementById('text_get_data');

            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        var data = xhr.responseText;
                        var obj_dic = JSON.parse(data);

                        var canvas=document.getElementById('pie-chart');
                        canvas.style.width=obj_dic.length * 30 + "px";

                        for (var i = 0; i < obj_dic.length; i++) {
                            var obj = obj_dic[i];
                            _labels[i] = obj['id'];
                            _datas[i] = obj[label];

                            if (i % 2 == 0) _colors[i] = '#FF0000'
                            else _colors[i] = '#0000FF'

                            if (i == 0) {
                                max_val = obj[label];
                                min_val = obj[label];
                            } else {
                                if (max_val < obj[label]) max_val = obj[label];
                                if (min_val < obj[label]) min_val = obj[label];
                            }
                        }

                        console.log(_labels);
                        console.log(_datas);

                        //  var wnm = obj['workcenter_nm'];
                        //  var cid = obj['cstctr_id'];

                        let barChart = new Chart(myChartOne, {
                            type: 'line',
                            data: {
                                labels: _labels,
                                datasets: [{
                                    label: 'e',
                                    data: _datas,
                                    backgroundColor: _colors,
                                    borderWidth: 1,
                                    borderColor: "#000000",
                                    hoverBorderWidth: 3,
                                }]
                            },
                            options: {
                                responsive: false,
                                scales: {
                                    xAxes: [{
                                        display: true,
                                        ticks: {
                                            width: 5000
                                        }
                                    }],
                                    yAxes: [{
                                        display: true,
                                        ticks: {
                                            suggestedMax: max_val,
                                            suggestedMin: min_val,
                                            beginAtZero: false
                                        }
                                    }]
                                }
                            }
                        })
                    }
                } else {
                    if (xhr.status == 400) {
                        var data = xhr.responseText;
                        var obj = JSON.parse(data);

                        if (obj.detail == "") {//추후 에러처리 추가시 사용
                            alert("에러코드");
                        } else {
                            alert("400 Bad Request");
                        }
                    }
                }
            };

            var strurl = "http://127.0.0.1:8080/rest_api/costbill1";
            xhr.open("GET", strurl, true);
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(null);
        }
    </script>
{% endblock %}